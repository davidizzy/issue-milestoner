name: PR Check - Orchestrator
on:
  pull_request:
    types: [opened, synchronize, reopened]
permissions:
  contents: read
  issues: write
  pull-requests: read
jobs:
  quality-checks:
    name: Quality Checks & Unit Tests
    uses: ./.github/workflows/quality-checks.yaml
  
  test-issue-milestoner:
    name: Integration Test - Issue Milestoner
    needs: quality-checks
    uses: ./.github/workflows/test-issue-milestoner.yaml
    with:
      pr_number: ${{ github.event.pull_request.number }}
      pr_author: ${{ github.event.pull_request.user.login }}
      pr_url: ${{ github.event.pull_request.html_url }}
      pr_branch: ${{ github.event.pull_request.head.ref }}
      pr_commit: ${{ github.event.pull_request.head.sha }}
    secrets: inherit
  
  report-results:
    name: Report PR Check Results
    runs-on: ubuntu-latest
    needs: [quality-checks, test-issue-milestoner]
    if: always()
    steps:
      - name: Report overall results
        run: |-
          quality_result="${{ needs.quality-checks.result }}"
          test_result="${{ needs.test-issue-milestoner.result }}"

          echo "## PR Check Results"
          echo "- **Quality Checks & Unit Tests**: $quality_result"
          echo "- **Integration Test**: $test_result"

          if [[ "$quality_result" == "success" ]] && [[ "$test_result" == "success" ]]; then
            echo ""
            echo "üéâ **All checks passed!** This PR is ready for review."
            exit 0
          else
            echo ""
            echo "‚ùå **Some checks failed.** Please review the failed jobs above."
            exit 1
          fi
