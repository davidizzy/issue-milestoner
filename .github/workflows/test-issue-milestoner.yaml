# This workflow tests the issue-milestoner action by creating a test issue
# assigned to a pull request author, invoking the action to assign a 
# milestone, and verifying the assignment.
# It can be triggered manually via workflow_dispatch.
# If running in a fork of this repo, ensure (1) the label "automated-test"
# and (2) a milestone called "pr-check-milestone" exist.

name: Test Issue Milestoner
on:
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number for testing context'
        required: false
        type: string
      pr_author:
        description: 'Pull request author for issue assignment'
        required: false
        type: string
      pr_url:
        description: 'Pull request URL for test issue context'
        required: false
        type: string
      pr_branch:
        description: 'Pull request branch name'
        required: false
        type: string
      pr_commit:
        description: 'Pull request commit SHA'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull request number for testing context'
        required: false
        type: string
      pr_author:
        description: 'Pull request author for issue assignment'
        required: false
        type: string
permissions:
  contents: read
  issues: write
jobs:
  test-milestone-assignment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # ratchet:actions/checkout@v6.0.0
      - name: Set test context
        id: test-info
        run: |
          # Use inputs or defaults for manual dispatch
          pr_number="${{ inputs.pr_number || 'manual' }}"
          pr_author="${{ inputs.pr_author || github.actor }}"
          pr_url="${{ inputs.pr_url || github.server_url }}/${{ github.repository }}"
          pr_branch="${{ inputs.pr_branch || github.ref_name }}"
          pr_commit="${{ inputs.pr_commit || github.sha }}"

          # Handle Dependabot PRs - assign to repository owner instead of bot
          if [[ "${pr_author}" == "dependabot[bot]" ]]; then
            pr_author="${{ github.repository_owner }}"
            echo "::notice::Dependabot PR detected, assigning to repository owner: ${pr_author}"
          fi

          {
            echo "pr_number=${pr_number}"
            echo "pr_author=${pr_author}"
            echo "pr_url=${pr_url}"
            echo "pr_branch=${pr_branch}"
            echo "pr_commit=${pr_commit}"
          } >> "${GITHUB_OUTPUT}"
      - name: Create test issue
        id: create-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_title="test of #${{ steps.test-info.outputs.pr_number }}"

          # Handle Dependabot PR messaging
          if [[ "${{ inputs.pr_author }}" == "dependabot[bot]" ]]; then
            author_info="Dependabot (assigned to @${{ steps.test-info.outputs.pr_author }})"
          else
            author_info="@${{ steps.test-info.outputs.pr_author }}"
          fi

          issue_body="Automated test issue created for PR #${{ steps.test-info.outputs.pr_number }} by ${author_info}.

          This issue will be used to test the milestone assignment functionality.

          **PR**: ${{ steps.test-info.outputs.pr_url }}
          **Branch**: \`${{ steps.test-info.outputs.pr_branch }}\`
          **Commit**: ${{ steps.test-info.outputs.pr_commit }}

          This issue will be automatically closed when the test completes."

          # Create issue and assign to PR author
          echo "::notice::Creating test issue..."
          if ! gh_output=$(gh issue create \
            --title "${issue_title}" \
            --body "${issue_body}" \
            --assignee "${{ steps.test-info.outputs.pr_author }}" \
            --label "automated-test" \
            --repo "${{ github.repository }}" 2>&1); then
            echo "::error::Failed to create test issue"
            echo "::error::GitHub CLI output: ${gh_output}"
            exit 1
          fi

          issue_number=$(echo "${gh_output}" | grep -oE 'issues/[0-9]+' | sed 's|issues/||')

          if [[ -z "${issue_number}" ]]; then
            echo "::error::Failed to extract issue number from GitHub CLI output"
            echo "::error::GitHub CLI output: ${gh_output}"
            exit 1
          fi

          echo "issue_number=${issue_number}" >> "${GITHUB_OUTPUT}"
          echo "::notice::Successfully created test issue #${issue_number}"
      - name: Test milestone assignment
        id: test-assignment
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.create-issue.outputs.issue_number }}
          target-milestone: "pr-check-milestone"
          repository: ${{ github.repository }}
      - name: Verify milestone assignment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Verifying milestone assignment"
          
          # Check action outputs
          assigned="${{ steps.test-assignment.outputs.assigned }}"
          milestone="${{ steps.test-assignment.outputs.milestone }}"
          reason="${{ steps.test-assignment.outputs.reason }}"
          
          echo "Action outputs:"
          echo "  assigned: ${assigned}"
          echo "  milestone: ${milestone}"
          echo "  reason: ${reason}"
          
          # Verify via GitHub API as well
          milestone_title=$(gh issue view "${{ steps.create-issue.outputs.issue_number }}" \
            --repo "${{ github.repository }}" \
            --json milestone \
            --jq '.milestone.title // empty')
          
          echo ""
          echo "GitHub API verification:"
          echo "  milestone: ${milestone_title}"
          
          if [[ "${assigned}" == "true" ]] && [[ "${milestone_title}" == "pr-check-milestone" ]]; then
            echo ""
            echo "‚úÖ SUCCESS: Issue #${{ steps.create-issue.outputs.issue_number }} is correctly assigned to milestone: ${milestone_title}"
          else
            echo ""
            echo "‚ùå FAILURE: Issue #${{ steps.create-issue.outputs.issue_number }} milestone assignment failed"
            echo "Expected: assigned=true, milestone=pr-check-milestone"
            echo "Actual: assigned=${assigned}, milestone=${milestone_title}"
            echo "Reason: ${reason}"
            exit 1
          fi
          echo "::endgroup::"
      - name: Clean up test issue
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Close the test issue as completed
          gh issue close "${{ steps.create-issue.outputs.issue_number }}" \
            --repo "${{ github.repository }}" \
            --reason completed \
            --comment "‚úÖ Test completed successfully. The milestone assignment functionality is working correctly for PR #${{ steps.test-info.outputs.pr_number }}."
          
          echo "::notice::Closed test issue #${{ steps.create-issue.outputs.issue_number }}"
      - name: Report test results
        if: always()
        run: |
          assigned="${{ steps.test-assignment.outputs.assigned }}"

          if [[ "${assigned}" == "true" ]]; then
            echo "üéâ **Test PASSED**: Issue milestoner functionality is working correctly!"
            echo "- Created test issue #${{ steps.create-issue.outputs.issue_number }}"
            echo "- Successfully assigned to milestone 'pr-check-milestone'"
            echo "- Cleaned up test issue"

          else
            echo "üí• **Test FAILED**: Issue milestoner functionality is not working correctly!"
            echo "Reason: ${{ steps.test-assignment.outputs.reason }}"

            echo "Please check the logs above for error details."
            exit 1
          fi
